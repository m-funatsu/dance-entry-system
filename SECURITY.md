# セキュリティ対策

このドキュメントでは、本システムで実装されているセキュリティ対策について説明します。

## 実装済みのセキュリティ対策

### 1. 認証・認可
- **Supabase Auth**による安全な認証システム
- **ミドルウェア**ですべてのルートとAPIエンドポイントを保護
- 管理者権限の厳格なチェック
- セッション管理とJWTトークンによる認証

### 2. APIエンドポイントの保護
- すべてのAPIエンドポイントで認証チェック
- 管理者専用APIへのアクセス制御
- 適切なHTTPステータスコード（401, 403）の返却

### 3. ファイルアップロードのセキュリティ
- **MIMEタイプのホワイトリスト検証**
- **ファイルシグネチャ（マジックナンバー）検証**
- **ファイルサイズ制限**
- **ファイル名のサニタイズ**（パストラバーサル攻撃対策）
- 危険な文字の除去と長さ制限

### 4. XSS（クロスサイトスクリプティング）対策
- React/Next.jsの自動エスケープ機能
- `dangerouslySetInnerHTML`の不使用
- セキュリティヘッダー（`X-XSS-Protection`）の設定

### 5. SQLインジェクション対策
- Supabaseのパラメータ化クエリ使用
- 直接的なSQL文字列結合の回避

### 6. セキュリティヘッダー
```
X-DNS-Prefetch-Control: on
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: camera=(), microphone=(), geolocation=()
Strict-Transport-Security: max-age=31536000; includeSubDomains
```

### 7. レート制限
- API全般：1分間に60リクエスト
- ログイン試行：5分間に5回まで
- ファイルアップロード：5分間に10回まで
- メール送信：1時間に10回まで

### 8. 環境変数の管理
- `.env.local`は`.gitignore`に含まれる
- `.env.local.example`でサンプル提供
- サービスロールキーは本番環境のみで設定

## セキュリティベストプラクティス

### 開発者向け
1. **環境変数の取り扱い**
   - 機密情報は絶対にコミットしない
   - 本番環境の環境変数はVercelダッシュボードで設定

2. **依存関係の管理**
   - 定期的に`npm audit`を実行
   - 脆弱性のあるパッケージは速やかに更新

3. **エラーハンドリング**
   - 詳細なエラー情報を外部に漏らさない
   - ログには機密情報を含めない

### 運用者向け
1. **定期的なセキュリティ監査**
   - アクセスログの確認
   - 異常なアクセスパターンの検知

2. **バックアップ**
   - データベースの定期バックアップ
   - ファイルストレージのバックアップ

3. **アクセス管理**
   - 管理者権限は必要最小限に
   - 定期的なパスワード変更

## インシデント対応

セキュリティインシデントが発生した場合：

1. **即座の対応**
   - 影響範囲の特定
   - 必要に応じてサービスの一時停止

2. **調査**
   - ログの確認
   - 侵入経路の特定

3. **復旧**
   - 脆弱性の修正
   - 影響を受けたデータの復元

4. **報告**
   - 関係者への通知
   - 再発防止策の策定

## 連絡先

セキュリティに関する問題を発見した場合は、速やかに管理者に連絡してください。